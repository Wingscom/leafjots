# Plan 02-01: Domain Models + Wallet Manager

## Phase Info
- **Phase**: 2 of 9 (v1.0)
- **Goal**: Create all domain models (Transaction, Account, Journal, Wallet subtypes), repositories, and /api/wallets CRUD with frontend Wallets page
- **Depends on**: Phase 1 (DB session, Base classes, enums)

## Tasks

### Task 1: Entity model
- Create `src/cryptotax/db/models/entity.py` — Entity (name, base_currency, soft delete)
- Create `src/cryptotax/db/repos/entity_repo.py` — get_by_id, get_default, create

### Task 2: Wallet models (STI)
- Create `src/cryptotax/db/models/wallet.py` — Single-Table Inheritance:
  - Base Wallet (entity_id, label, wallet_type, sync_status)
  - OnChainWallet (chain, address, last_block_loaded, last_synced_at)
  - CEXWallet (exchange, api_key_encrypted, api_secret_encrypted, last_trade_id)
- Create `src/cryptotax/db/repos/wallet_repo.py` — create, list_for_entity, get_by_chain_and_address, create_cex_wallet

### Task 3: Transaction model
- Create `src/cryptotax/db/models/transaction.py` — wallet_id, chain, tx_hash, block_number, timestamp, from_addr, to_addr, value_wei, gas_used, status, entry_type, tx_data (JSON)
- Create `src/cryptotax/db/repos/transaction_repo.py` — get_by_hash, list_for_wallet, list_for_entity

### Task 4: Account model (STI with 8 subtypes)
- Create `src/cryptotax/db/models/account.py` — Single-Table Inheritance:
  - NativeAsset, ERC20Token, ProtocolAsset, ProtocolDebt
  - WalletIncome, WalletExpense, ExternalTransfer, ManualEntry
- Create `src/cryptotax/db/repos/account_repo.py` — get_or_create_by_label, get_for_wallet

### Task 5: Journal models
- Create `src/cryptotax/db/models/journal.py` — JournalEntry (entity_id, transaction_id, entry_type, description, splits) + JournalSplit (account_id, quantity, value_usd, value_vnd)
- Create `src/cryptotax/db/repos/journal_repo.py` — create, list_for_entity
- Balance validation: all splits per entry must sum to zero

### Task 6: Models __init__.py exports
- Create `src/cryptotax/db/models/__init__.py` — export all models for Alembic autodiscovery

### Task 7: Wallets API endpoints
- Create `src/cryptotax/api/wallets.py`:
  - POST /api/wallets — add on-chain wallet
  - POST /api/wallets/cex — add CEX wallet (encrypted credentials)
  - GET /api/wallets — list wallets for entity
  - GET /api/wallets/{id} — wallet detail
  - DELETE /api/wallets/{id} — remove wallet
  - POST /api/wallets/{id}/sync — trigger sync
- Create `src/cryptotax/api/schemas/wallets.py` — request/response schemas
- Wire router into main.py

### Task 8: Frontend Wallets page
- Create `web/src/api/wallets.ts` — API client (add, list, delete, sync)
- Create `web/src/hooks/useWallets.ts` — TanStack Query hooks
- Create `web/src/pages/Wallets.tsx`:
  - Add on-chain wallet form (chain dropdown, address input)
  - Add CEX wallet form (exchange, api_key, api_secret)
  - Wallet list table with sync status badge
  - "Sync Now" button per wallet
  - Delete button with confirmation
- Update Dashboard.tsx with wallet count card

### Task 9: Alembic migration
- Create migration adding last_synced_at to wallets table

### Task 10: Tests
- Create `tests/unit/test_wallet_repo.py` — repo CRUD tests
- Create `tests/integration/test_wallets_api.py` — API endpoint tests

## Files

| File | Action |
|------|--------|
| `src/cryptotax/db/models/entity.py` | CREATE |
| `src/cryptotax/db/models/wallet.py` | CREATE |
| `src/cryptotax/db/models/transaction.py` | CREATE |
| `src/cryptotax/db/models/account.py` | CREATE |
| `src/cryptotax/db/models/journal.py` | CREATE |
| `src/cryptotax/db/models/__init__.py` | CREATE |
| `src/cryptotax/db/repos/entity_repo.py` | CREATE |
| `src/cryptotax/db/repos/wallet_repo.py` | CREATE |
| `src/cryptotax/db/repos/transaction_repo.py` | CREATE |
| `src/cryptotax/db/repos/account_repo.py` | CREATE |
| `src/cryptotax/db/repos/journal_repo.py` | CREATE |
| `src/cryptotax/api/wallets.py` | CREATE |
| `src/cryptotax/api/schemas/wallets.py` | CREATE |
| `src/cryptotax/api/main.py` | MODIFY (add wallets router) |
| `web/src/api/wallets.ts` | CREATE |
| `web/src/hooks/useWallets.ts` | CREATE |
| `web/src/pages/Wallets.tsx` | CREATE |
| `web/src/pages/Dashboard.tsx` | MODIFY (add wallet count) |
| `alembic/versions/phase2_*.py` | CREATE |
| `tests/unit/test_wallet_repo.py` | CREATE |
| `tests/integration/test_wallets_api.py` | CREATE |
