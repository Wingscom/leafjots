# Plan 03-01: EVM Infrastructure + TX Viewer

## Phase Info
- **Phase**: 3 of 9 (v1.0)
- **Goal**: Build blockchain infrastructure (Web3 providers, Etherscan client, TX loaders for EVM + Solana), transaction API, and frontend TX viewer
- **Depends on**: Phase 2 (Wallet, Transaction models and repos)

## Tasks

### Task 1: HTTP rate-limited client
- Create `src/cryptotax/infra/http/rate_limited_client.py` — Retry logic, rate limiting, exponential backoff with tenacity

### Task 2: Etherscan client
- Create `src/cryptotax/infra/blockchain/evm/etherscan_client.py`:
  - Rate-limited API calls to Etherscan
  - get_tx_list, get_tx_by_hash, get_internal_txs
  - get_token_transfers (ERC20)
  - get_logs, get_contract_abi
  - Support multiple chains (Etherscan, BSCScan, Polygonscan, Arbiscan)

### Task 3: EVM TX loader
- Create `src/cryptotax/infra/blockchain/evm/tx_loader.py`:
  - EVMTxLoader: fetch TXs from Etherscan, normalize to Transaction model
  - Track last_block_loaded per wallet
  - Reorg safety margin (50 blocks behind head)
  - Store raw TX data as JSON in tx_data column
- Create `src/cryptotax/infra/blockchain/base.py` — ChainTxLoader abstract base

### Task 4: Solana support
- Create `src/cryptotax/infra/blockchain/solana/rpc_client.py` — Helius RPC client
- Create `src/cryptotax/infra/blockchain/solana/tx_loader.py` — Solana TX loader

### Task 5: Transactions API
- Create `src/cryptotax/api/transactions.py`:
  - GET /api/transactions — list with pagination, filter by wallet/chain/status
  - GET /api/transactions/{tx_hash} — detail view with raw data
  - GET /api/transactions/{tx_hash}/events — decoded events
  - GET /api/transactions/{tx_hash}/transfers — extracted transfers
- Create `src/cryptotax/api/schemas/transactions.py` — response schemas
- Wire router into main.py

### Task 6: Wallet sync endpoint integration
- Update `POST /api/wallets/{id}/sync` to actually trigger EVMTxLoader
- Track sync progress (Celery task or inline)

### Task 7: Frontend Transactions page
- Create `web/src/api/transactions.ts` — API client
- Create `web/src/hooks/useTransactions.ts` — TanStack Query hooks
- Create `web/src/pages/Transactions.tsx`:
  - Transaction list table (paginated)
  - Filter by wallet, chain, status (parsed/unparsed/error)
  - Click TX → detail drawer/modal:
    - Hash, block, from, to, value, gas
    - Decoded events/logs
    - Transfer list (ERC20, native)
    - Link to block explorer
  - Status badges: "Parsed", "Unparsed", "Error"

### Task 8: Block explorer links
- Create `web/src/api/explorer.ts` — Generate explorer URLs for each chain (Etherscan, BSCScan, etc.)

### Task 9: Alembic migration
- Add event/transfer metadata columns to transactions table

### Task 10: Tests
- Create `tests/integration/test_transactions_api.py`
- Create `tests/unit/infra/test_solana_loader.py`

## Files

| File | Action |
|------|--------|
| `src/cryptotax/infra/http/rate_limited_client.py` | CREATE |
| `src/cryptotax/infra/blockchain/base.py` | CREATE |
| `src/cryptotax/infra/blockchain/evm/etherscan_client.py` | CREATE |
| `src/cryptotax/infra/blockchain/evm/tx_loader.py` | CREATE |
| `src/cryptotax/infra/blockchain/solana/rpc_client.py` | CREATE |
| `src/cryptotax/infra/blockchain/solana/tx_loader.py` | CREATE |
| `src/cryptotax/api/transactions.py` | CREATE |
| `src/cryptotax/api/schemas/transactions.py` | CREATE |
| `src/cryptotax/api/main.py` | MODIFY (add transactions router) |
| `web/src/api/transactions.ts` | CREATE |
| `web/src/api/explorer.ts` | CREATE |
| `web/src/hooks/useTransactions.ts` | CREATE |
| `web/src/pages/Transactions.tsx` | CREATE |
| `alembic/versions/phase3_*.py` | CREATE |
| `tests/integration/test_transactions_api.py` | CREATE |
| `tests/unit/infra/test_solana_loader.py` | CREATE |
