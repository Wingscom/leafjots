# Plan 04-01: Parser Engine + Journal/Error Views

## Phase Info
- **Phase**: 4 of 9 (v1.0)
- **Goal**: Build parser engine (GenericEVM, GenericSwap, ParserRegistry), Bookkeeper for journal creation, AccountMapper, and frontend pages for Parser Debug, Journal, Accounts, and Errors
- **Depends on**: Phase 3 (Transaction model with TX data, transfers, events)

## Tasks

### Task 1: Parser base + types
- Create `src/cryptotax/parser/generic/base.py` — BaseParser abstract class (can_parse, parse methods)
- Create `src/cryptotax/parser/utils/types.py` — ParsedSplit, ParseResult, ParserContext dataclasses
- Create `src/cryptotax/parser/utils/context.py` — TransactionContext (transfers, events, wallet_addresses)

### Task 2: Parser utilities
- Create `src/cryptotax/parser/utils/gas.py` — make_gas_splits, native_symbol per chain
- Create `src/cryptotax/parser/utils/transfers.py` — extract_all_transfers (ERC20, native, NFT detection)
- Create `src/cryptotax/parser/handlers/common.py` — Common handler functions
- Create `src/cryptotax/parser/handlers/wrap.py` — WETH wrap/unwrap handler

### Task 3: GenericEVMParser (Layer 1)
- Create `src/cryptotax/parser/generic/evm.py`:
  - Always-fallback parser (can_parse returns True)
  - Handles gas fees + simple transfers
  - Extracts ERC20 transfers, creates journal splits
  - ENTRY_TYPE = TRANSFER

### Task 4: GenericSwapParser (Layer 2)
- Create `src/cryptotax/parser/generic/swap.py`:
  - Detects A→B token transfer pattern (bidirectional flow to/from wallet)
  - ENTRY_TYPE = SWAP
  - Creates balanced swap splits (asset_a -qty, asset_b +qty)

### Task 5: ParserRegistry
- Create `src/cryptotax/parser/registry.py`:
  - Map (chain, contract_address) → [protocol_parser, ...fallbacks]
  - build_default_registry(): pre-registers all parsers
  - Fallback chain: protocol-specific → GenericSwap → GenericEVM

### Task 6: AccountMapper
- Create `src/cryptotax/accounting/account_mapper.py`:
  - Lazy get-or-create accounts by hierarchical label
  - Methods: native_asset, erc20_token, gas_expense, protocol_asset, protocol_debt, wallet_income, wallet_expense, external_transfer

### Task 7: Bookkeeper
- Create `src/cryptotax/accounting/bookkeeper.py`:
  - Orchestrates: TX → Parser → AccountMapper → JournalEntry
  - Parser selection via registry
  - Captures diagnostics on failure
  - Validates balance (splits sum to zero)
  - Records parse errors gracefully

### Task 8: ParseErrorRecord model + repo
- Create `src/cryptotax/db/models/parse_error_record.py` — entity_id, tx_hash, error_type, message, stack_trace
- Create `src/cryptotax/db/repos/parse_error_repo.py` — list_for_entity, create, mark_ignored

### Task 9: Parser API
- Create `src/cryptotax/api/parser.py`:
  - POST /api/parse/test — test-parse single TX hash (dry-run or persist)
  - POST /api/parse/wallet/{id} — re-parse all TXs for wallet
  - GET /api/parse/stats — parser coverage stats
  - GET /api/parse/errors — list parse errors
  - GET /api/parse/unknown — list unknown/unclassified TXs
- Create `src/cryptotax/api/schemas/parse.py` — schemas

### Task 10: Journal API
- Create `src/cryptotax/api/journal.py`:
  - GET /api/journal — list entries (paginated)
  - GET /api/journal/{id} — entry detail with splits
  - GET /api/journal/validation — list unbalanced entries
- Create `src/cryptotax/api/schemas/journal.py` — schemas

### Task 11: Accounts API
- Create `src/cryptotax/api/accounts.py`:
  - GET /api/accounts — list all accounts + balances (tree structure)
  - GET /api/accounts/{id}/history — splits for this account
  - GET /api/accounts/reconciliation — on-chain vs journal comparison
- Create `src/cryptotax/api/schemas/accounts.py` — schemas

### Task 12: Errors API
- Create `src/cryptotax/api/errors.py`:
  - GET /api/errors — all errors by type
  - GET /api/errors/summary — counts by type
  - POST /api/errors/{id}/retry — retry failed parse
  - POST /api/errors/{id}/ignore — mark as ignored
  - POST /api/prices/manual — insert manual price
- Create `src/cryptotax/api/schemas/errors.py` — schemas

### Task 13: Frontend Parser Debug page
- Create `web/src/pages/ParserDebug.tsx`:
  - "Test Parse" input: paste TX hash
  - Show which parser selected, journal splits, balance check
  - Re-parse button, bulk re-parse for wallet
  - Parser stats panel (parsed %, protocol breakdown)
- Create `web/src/api/parse.ts` + `web/src/hooks/useParser.ts`

### Task 14: Frontend Journal page
- Create `web/src/pages/Journal.tsx`:
  - Journal entry list (paginated)
  - Expandable splits view (account, symbol, quantity, value_usd, value_vnd)
  - Color coding by account type, balance validation indicator
- Create `web/src/api/journal.ts` + `web/src/hooks/useJournal.ts`

### Task 15: Frontend Accounts page
- Create `web/src/pages/Accounts.tsx`:
  - Tree view grouped by account type (ASSET, LIABILITY, INCOME, EXPENSE)
  - Click account → transaction history
  - Balance at date, reconciliation check
- Create `web/src/api/accounts.ts` + `web/src/hooks/useAccounts.ts`

### Task 16: Frontend Errors page
- Create `web/src/pages/Errors.tsx`:
  - Tabs: Parse Errors, Unknown TXs, Price Missing, Unbalanced, Warnings
  - Retry Parse, Mark Ignored, Enter Manual Price buttons
  - Summary bar with color-coded counts
- Create `web/src/api/errors.ts` + `web/src/hooks/useErrors.ts`

### Task 17: Alembic migration
- Add indexes on accounts, journal_splits, parse_error_records

### Task 18: Tests
- Unit tests for parser context, gas, handlers, transfers
- Integration tests for bookkeeper, parse API

## Files

| File | Action |
|------|--------|
| `src/cryptotax/parser/generic/base.py` | CREATE |
| `src/cryptotax/parser/generic/evm.py` | CREATE |
| `src/cryptotax/parser/generic/swap.py` | CREATE |
| `src/cryptotax/parser/utils/types.py` | CREATE |
| `src/cryptotax/parser/utils/context.py` | CREATE |
| `src/cryptotax/parser/utils/gas.py` | CREATE |
| `src/cryptotax/parser/utils/transfers.py` | CREATE |
| `src/cryptotax/parser/handlers/common.py` | CREATE |
| `src/cryptotax/parser/handlers/wrap.py` | CREATE |
| `src/cryptotax/parser/registry.py` | CREATE |
| `src/cryptotax/accounting/account_mapper.py` | CREATE |
| `src/cryptotax/accounting/bookkeeper.py` | CREATE |
| `src/cryptotax/db/models/parse_error_record.py` | CREATE |
| `src/cryptotax/db/repos/parse_error_repo.py` | CREATE |
| `src/cryptotax/api/parser.py` | CREATE |
| `src/cryptotax/api/journal.py` | CREATE |
| `src/cryptotax/api/accounts.py` | CREATE |
| `src/cryptotax/api/errors.py` | CREATE |
| `src/cryptotax/api/schemas/parse.py` | CREATE |
| `src/cryptotax/api/schemas/journal.py` | CREATE |
| `src/cryptotax/api/schemas/accounts.py` | CREATE |
| `src/cryptotax/api/schemas/errors.py` | CREATE |
| `web/src/pages/ParserDebug.tsx` | CREATE |
| `web/src/pages/Journal.tsx` | CREATE |
| `web/src/pages/Accounts.tsx` | CREATE |
| `web/src/pages/Errors.tsx` | CREATE |
| `web/src/api/parse.ts` | CREATE |
| `web/src/api/journal.ts` | CREATE |
| `web/src/api/accounts.ts` | CREATE |
| `web/src/api/errors.ts` | CREATE |
| `web/src/hooks/useParser.ts` | CREATE |
| `web/src/hooks/useJournal.ts` | CREATE |
| `web/src/hooks/useAccounts.ts` | CREATE |
| `web/src/hooks/useErrors.ts` | CREATE |
| `alembic/versions/phase4_*.py` | CREATE |
| `tests/unit/parser/*.py` | CREATE (4+ files) |
| `tests/integration/test_bookkeeper.py` | CREATE |
| `tests/integration/test_parse_api.py` | CREATE |
