# Plan 05-01: DeFi Protocol Parsers

## Phase Info
- **Phase**: 5 of 9 (v1.0)
- **Goal**: Build protocol-specific parsers for major DeFi protocols (Aave V3, Uniswap V3, Curve, PancakeSwap) and CEX infrastructure (Binance API)
- **Depends on**: Phase 4 (BaseParser, ParserRegistry, Bookkeeper, AccountMapper)

## Tasks

### Task 1: Aave V3 Parser
- Create `src/cryptotax/parser/defi/aave_v3.py`:
  - AaveV3Parser matching AAVE_V3_POOL addresses by chain
  - Handle: Supply, Borrow, Repay, Withdraw, FlashLoan
  - Uses protocol_asset for deposits, protocol_debt for borrows
  - ENTRY_TYPE dynamically set per operation

### Task 2: Uniswap V3 Parser
- Create `src/cryptotax/parser/defi/uniswap_v3.py`:
  - UniswapV3Parser matching UNISWAP_V3_ROUTERS and NFT_MANAGER
  - Handle: Swap, LP Mint, LP Burn, Collect Fees
  - LP positions tracked via protocol_asset accounts

### Task 3: Curve Pool Parser
- Create `src/cryptotax/parser/defi/curve.py`:
  - CurvePoolParser matching known CURVE_POOLS addresses
  - Handle: Swap (exchange), Add Liquidity, Remove Liquidity
  - LP token tracking

### Task 4: PancakeSwap Parser
- Create `src/cryptotax/parser/defi/pancakeswap.py`:
  - PancakeSwapParser matching PANCAKESWAP_ROUTERS
  - Handle: Swap, LP operations
  - Multi-chain support (BSC + Ethereum)

### Task 5: CEX encryption utilities
- Create `src/cryptotax/infra/cex/crypto.py` — AES-256 encrypt_value/decrypt_value for API credentials

### Task 6: Binance API client
- Create `src/cryptotax/infra/cex/binance_client.py`:
  - BinanceClient with HMAC-SHA256 signing
  - Endpoints: trades, deposits, withdrawals
  - Rate limiting and error handling

### Task 7: Binance loader
- Create `src/cryptotax/infra/cex/binance_loader.py`:
  - BinanceLoader: fetch trades, deposits, withdrawals
  - Normalize to Transaction model format
  - Track last_trade_id for incremental sync

### Task 8: Binance parsers (API format)
- Create `src/cryptotax/parser/cex/binance.py`:
  - BinanceTradeParser — spot trades
  - BinanceDepositParser — fiat/crypto deposits
  - BinanceWithdrawalParser — withdrawals

### Task 9: Register all parsers
- Update `src/cryptotax/parser/registry.py` — build_default_registry():
  - Register Aave V3 pool addresses (Ethereum, Polygon, Arbitrum)
  - Register Uniswap V3 routers (all chains)
  - Register Curve pools
  - Register PancakeSwap routers (BSC, Ethereum)
  - Register Binance parsers

### Task 10: Tests
- Create tests for each parser:
  - `tests/unit/parser/test_aave_v3.py`
  - `tests/unit/parser/test_uniswap_v3.py`
  - `tests/unit/parser/test_curve.py`
  - `tests/unit/parser/test_pancakeswap.py`
  - `tests/unit/parser/test_generic_swap.py`
  - `tests/unit/parser/test_generic_evm.py`
  - `tests/unit/parser/test_binance_parsers.py`
- Create `tests/integration/test_protocol_parse.py` — end-to-end protocol parsing
- Create `tests/unit/infra/test_binance_client.py`
- Create `tests/unit/infra/test_binance_loader.py`

## Files

| File | Action |
|------|--------|
| `src/cryptotax/parser/defi/aave_v3.py` | CREATE |
| `src/cryptotax/parser/defi/uniswap_v3.py` | CREATE |
| `src/cryptotax/parser/defi/curve.py` | CREATE |
| `src/cryptotax/parser/defi/pancakeswap.py` | CREATE |
| `src/cryptotax/infra/cex/crypto.py` | CREATE |
| `src/cryptotax/infra/cex/binance_client.py` | CREATE |
| `src/cryptotax/infra/cex/binance_loader.py` | CREATE |
| `src/cryptotax/parser/cex/binance.py` | CREATE |
| `src/cryptotax/parser/registry.py` | MODIFY (register all) |
| `tests/unit/parser/test_aave_v3.py` | CREATE |
| `tests/unit/parser/test_uniswap_v3.py` | CREATE |
| `tests/unit/parser/test_curve.py` | CREATE |
| `tests/unit/parser/test_pancakeswap.py` | CREATE |
| `tests/unit/parser/test_generic_swap.py` | CREATE |
| `tests/unit/parser/test_generic_evm.py` | CREATE |
| `tests/unit/parser/test_binance_parsers.py` | CREATE |
| `tests/integration/test_protocol_parse.py` | CREATE |
| `tests/unit/infra/test_binance_client.py` | CREATE |
| `tests/unit/infra/test_binance_loader.py` | CREATE |
