# Plan 06-01: Price + Tax Engine

## Phase Info
- **Phase**: 6 of 9 (v1.0)
- **Goal**: Build price infrastructure (CoinGecko), FIFO capital gains engine, Vietnam 0.1% transfer tax with VND 20M exemption, Tax API, and frontend Tax page
- **Depends on**: Phase 5 (parsers producing journal entries with quantities)

## Tasks

### Task 1: Price cache model
- Create `src/cryptotax/db/models/price_cache.py` — PriceCache (symbol, chain, token_address, timestamp, price_usd, source)

### Task 2: CoinGecko client
- Create `src/cryptotax/infra/price/coingecko.py`:
  - CoinGeckoClient with rate limiting
  - get_price_at_timestamp(symbol, timestamp) -> price_usd
  - Token ID mapping (symbol -> CoinGecko ID)
  - Fallback to daily prices if minute-level unavailable

### Task 3: Price service
- Create `src/cryptotax/infra/price/service.py`:
  - PriceService: cache-first lookup
  - Check price_cache DB -> call CoinGecko -> persist to cache
  - get_price_usd(symbol, timestamp) -> Decimal

### Task 4: Capital gains models
- Create `src/cryptotax/db/models/capital_gains.py`:
  - ClosedLotRecord (buy_tx_id, sell_tx_id, quantity, cost_basis_usd, proceeds_usd, gain_usd, holding_days)
  - OpenLotRecord (buy_tx_id, remaining_quantity, cost_basis_per_unit_usd)

### Task 5: Tax domain models
- Create `src/cryptotax/domain/models/tax.py`:
  - Trade, ClosedLot, OpenLot dataclasses
  - TaxableTransfer, TaxSummary dataclasses

### Task 6: FIFO engine
- Create `src/cryptotax/accounting/fifo.py`:
  - fifo_match(): pure function, GLOBAL_FIFO matching
  - trades_from_splits(): convert journal splits -> Trade events
  - Calculates: gain_usd, cost_basis, proceeds, holding_days
  - Per-symbol lot tracking

### Task 7: Tax engine
- Create `src/cryptotax/accounting/tax_engine.py`:
  - TaxEngine orchestrates FIFO + Vietnam 0.1% transfer tax
  - calculate(entity_id, start_date, end_date) -> persists results
  - Vietnam tax rules:
    - TAX_RATE = 0.1% (0.001)
    - EXEMPTION_THRESHOLD_VND = 20,000,000
    - Exempt if single transfer > VND 20M
  - Loads journal splits in date range, runs FIFO, persists closed/open lots

### Task 8: Tax API
- Create `src/cryptotax/api/tax.py`:
  - POST /api/tax/calculate — run full FIFO + tax calculation
  - GET /api/tax/realized-gains — realized gains list
  - GET /api/tax/open-lots — open lots view
  - GET /api/tax/transfers — all taxable transfers (showing exemption reason)
  - GET /api/tax/summary — total tax due
- Create `src/cryptotax/api/schemas/tax.py` — schemas

### Task 9: Frontend Tax page
- Create `web/src/pages/Tax.tsx`:
  - Entity + date range selector
  - "Calculate Tax" button
  - Results: realized gains summary, 0.1% tax per transfer, exempted transfers, total tax due
  - Open lots view (unrealized positions)
  - Lot matching detail
- Create `web/src/api/tax.ts` + `web/src/hooks/useTax.ts`

### Task 10: Dashboard updates
- Update Dashboard.tsx: add portfolio value chart (Recharts), tax liability summary

### Task 11: Alembic migration
- Create migration for price_cache, closed_lot_records, open_lot_records tables

### Task 12: Tests
- `tests/unit/accounting/test_fifo.py` — FIFO matching logic
- `tests/unit/accounting/test_tax_engine_unit.py` — tax calculation
- `tests/unit/price/test_coingecko.py` — CoinGecko client
- `tests/unit/price/test_price_cache.py` — cache behavior
- `tests/unit/price/test_price_service.py` — service integration
- `tests/integration/test_tax_api.py` — API endpoints

## Files

| File | Action |
|------|--------|
| `src/cryptotax/db/models/price_cache.py` | CREATE |
| `src/cryptotax/db/models/capital_gains.py` | CREATE |
| `src/cryptotax/domain/models/tax.py` | CREATE |
| `src/cryptotax/infra/price/coingecko.py` | CREATE |
| `src/cryptotax/infra/price/service.py` | CREATE |
| `src/cryptotax/accounting/fifo.py` | CREATE |
| `src/cryptotax/accounting/tax_engine.py` | CREATE |
| `src/cryptotax/api/tax.py` | CREATE |
| `src/cryptotax/api/schemas/tax.py` | CREATE |
| `src/cryptotax/api/main.py` | MODIFY (add tax router) |
| `web/src/pages/Tax.tsx` | CREATE |
| `web/src/api/tax.ts` | CREATE |
| `web/src/hooks/useTax.ts` | CREATE |
| `web/src/pages/Dashboard.tsx` | MODIFY (add charts) |
| `alembic/versions/phase6_*.py` | CREATE |
| `tests/unit/accounting/test_fifo.py` | CREATE |
| `tests/unit/accounting/test_tax_engine_unit.py` | CREATE |
| `tests/unit/price/test_coingecko.py` | CREATE |
| `tests/unit/price/test_price_cache.py` | CREATE |
| `tests/unit/price/test_price_service.py` | CREATE |
| `tests/integration/test_tax_api.py` | CREATE |
