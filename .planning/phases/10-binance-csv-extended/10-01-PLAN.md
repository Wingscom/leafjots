# Plan 10-01: Binance CSV Extended Operations Parser

## Metadata
- **Phase**: 10 — Binance CSV Parser -- Earn, Futures, Margin & Specials
- **Requirements**: BCSV-07, BCSV-08, BCSV-09, BCSV-10, BCSV-11, BCSV-12, BCSV-13, BCSV-14, BCSV-15
- **Depends on**: Phase 9 (BinanceCsvParser with grouping, dispatch, journal entry creation)
- **Estimated files**: 1 modified (parser), 1 modified (test), 1 new (test)

## Goal
Extend BinanceCsvParser to handle all remaining Binance operation types: Simple Earn, Futures, Margin, Flexible Loans, special tokens (RWUSD/BFUSD/WBETH), and Cashback — achieving full coverage of all 36 unique operations found in the real CSV data.

## Context

### What exists (after Phase 9)
- `BinanceCsvParser` in `src/cryptotax/parser/cex/binance_csv.py` with:
  - `_parse_group()` dispatch method with TRADE_OPS, CORE_OPS constants
  - 6 handlers: spot_trade, convert, deposit, withdraw, p2p, internal_transfer
  - `_create_journal_entry()` and `_resolve_account()` for journal creation
  - Unknown operations marked as "skipped"
- `AccountMapper` with `cex_asset()`, `cex_expense()`, `income()`, `external_transfer()`, `protocol_asset()`, `protocol_debt()`
- 422 tests passing, 0 lint, 0 TS errors

### Remaining operations from real CSV (18 new operation types)
1. **Simple Earn**: Flexible Subscription, Flexible Redemption, Flexible Interest, Locked Subscription, Locked Rewards
2. **Futures**: Fee, Funding Fee, Realized Profit and Loss
3. **Margin**: Isolated Margin Loan, Isolated Margin Liquidation - Forced Repayment, Cross Margin Liquidation - Small Assets Takeover
4. **Flexible Loan**: Collateral Transfer, Lending, Repayment
5. **Special tokens**: RWUSD - Subscription/Distribution/Redemption, BFUSD Subscription, BFUSD Daily Reward, WBETH2.0 - Staking
6. **Other**: Cashback Voucher, Transfer Funds to Spot, Transfer Funds to Funding Wallet

## Tasks

### Task 1: Add new operation constants and extend dispatch
**File**: `src/cryptotax/parser/cex/binance_csv.py`

Add new operation sets:
```python
EARN_OPS = frozenset({
    "Simple Earn Flexible Subscription",
    "Simple Earn Flexible Redemption",
    "Simple Earn Locked Subscription",
    "Simple Earn Flexible Interest",
    "Simple Earn Locked Rewards",
})

FUTURES_OPS = frozenset({
    "Fee",  # Futures trading fee
    "Funding Fee",
    "Realized Profit and Loss",
})

MARGIN_OPS = frozenset({
    "Isolated Margin Loan",
    "Isolated Margin Liquidation - Forced Repayment",
    "Cross Margin Liquidation - Small Assets Takeover",
})

LOAN_OPS = frozenset({
    "Flexible Loan - Collateral Transfer",
    "Flexible Loan - Lending",
    "Flexible Loan - Repayment",
})

SPECIAL_TOKEN_OPS = frozenset({
    "RWUSD - Subscription",
    "RWUSD - Distribution",
    "RWUSD - Redemption",
    "BFUSD Subscription",
    "BFUSD Daily Reward",
    "WBETH2.0 - Staking",
})

TRANSFER_FUND_OPS = frozenset({
    "Transfer Funds to Spot",
    "Transfer Funds to Funding Wallet",
})
```

Update `_parse_group()` dispatch to route to new handlers:
```python
# After existing dispatch...
earn_rows = [r for r in rows if r.operation in EARN_OPS]
futures_rows = [r for r in rows if r.operation in FUTURES_OPS]
margin_rows = [r for r in rows if r.operation in MARGIN_OPS]
loan_rows = [r for r in rows if r.operation in LOAN_OPS]
special_rows = [r for r in rows if r.operation in SPECIAL_TOKEN_OPS]
cashback_rows = [r for r in rows if r.operation == "Cashback Voucher"]
fund_transfer_rows = [r for r in rows if r.operation in TRANSFER_FUND_OPS]

for r in earn_rows:
    entries.append(self._handle_earn(r))
for r in futures_rows:
    entries.append(self._handle_futures(r))
for r in margin_rows:
    entries.append(self._handle_margin(r))
for r in loan_rows:
    entries.append(self._handle_loan(r))
# Special tokens: group by timestamp (e.g. RWUSD Sub+Spend at same time)
if special_rows:
    entries.extend(self._handle_special_tokens(special_rows))
for r in cashback_rows:
    entries.append(self._handle_cashback(r))
if fund_transfer_rows:
    entries.append(self._handle_internal_transfer(fund_transfer_rows))
```

Update categorised set to include all new ops in the "other_rows" filter.

### Task 2: Implement Simple Earn handlers (BCSV-07, BCSV-08)
**File**: `src/cryptotax/parser/cex/binance_csv.py`

```python
def _handle_earn(self, row: CsvImportRow) -> ParsedEntry:
    """Simple Earn operations."""
    amount = Decimal(row.change)
    op = row.operation

    if op in ("Simple Earn Flexible Subscription", "Simple Earn Locked Subscription"):
        # Move from spot to earn: negative = deducted from spot
        splits = [
            ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount),
            ParsedSplit(
                account_subtype="protocol_asset", symbol=row.coin, quantity=-amount,
                account_params={"protocol": "binance_earn"},
            ),
        ]
        return ParsedEntry(splits=splits, entry_type="DEPOSIT", source_rows=[row])

    elif op == "Simple Earn Flexible Redemption":
        # Move from earn back to spot: positive = received in spot
        splits = [
            ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount),
            ParsedSplit(
                account_subtype="protocol_asset", symbol=row.coin, quantity=-amount,
                account_params={"protocol": "binance_earn"},
            ),
        ]
        return ParsedEntry(splits=splits, entry_type="WITHDRAWAL", source_rows=[row])

    elif op in ("Simple Earn Flexible Interest", "Simple Earn Locked Rewards"):
        # Interest/rewards: income
        splits = [
            ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount),
            ParsedSplit(
                account_subtype="wallet_income", symbol=row.coin, quantity=-amount,
                account_params={"tag": "Earn Interest"},
            ),
        ]
        return ParsedEntry(splits=splits, entry_type="YIELD", source_rows=[row])

    # Fallback
    return ParsedEntry(
        splits=[ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount)],
        entry_type="UNKNOWN",
        source_rows=[row],
    )
```

### Task 3: Implement Futures handlers (BCSV-09, BCSV-10)
**File**: `src/cryptotax/parser/cex/binance_csv.py`

```python
def _handle_futures(self, row: CsvImportRow) -> ParsedEntry:
    """Futures Fee, Funding Fee, Realized PnL."""
    amount = Decimal(row.change)
    op = row.operation

    if op == "Fee":
        # Trading fee: negative = expense
        splits = [
            ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount),
            ParsedSplit(account_subtype="wallet_expense", symbol=row.coin, quantity=-amount),
        ]
        return ParsedEntry(splits=splits, entry_type="GAS_FEE", source_rows=[row])

    elif op == "Funding Fee":
        # Funding fee: can be positive (received) or negative (paid)
        if amount < 0:
            splits = [
                ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount),
                ParsedSplit(account_subtype="wallet_expense", symbol=row.coin, quantity=-amount),
            ]
            return ParsedEntry(splits=splits, entry_type="GAS_FEE", source_rows=[row])
        else:
            splits = [
                ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount),
                ParsedSplit(
                    account_subtype="wallet_income", symbol=row.coin, quantity=-amount,
                    account_params={"tag": "Funding Fee"},
                ),
            ]
            return ParsedEntry(splits=splits, entry_type="YIELD", source_rows=[row])

    elif op == "Realized Profit and Loss":
        # PnL: positive = income, negative = loss (expense)
        if amount >= 0:
            splits = [
                ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount),
                ParsedSplit(
                    account_subtype="wallet_income", symbol=row.coin, quantity=-amount,
                    account_params={"tag": "Futures PnL"},
                ),
            ]
            return ParsedEntry(splits=splits, entry_type="YIELD", source_rows=[row])
        else:
            splits = [
                ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount),
                ParsedSplit(account_subtype="wallet_expense", symbol=row.coin, quantity=-amount),
            ]
            return ParsedEntry(splits=splits, entry_type="GAS_FEE", source_rows=[row])

    return ParsedEntry(
        splits=[ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount)],
        entry_type="UNKNOWN", source_rows=[row],
    )
```

### Task 4: Implement Margin handlers (BCSV-11, BCSV-12)
**File**: `src/cryptotax/parser/cex/binance_csv.py`

```python
def _handle_margin(self, row: CsvImportRow) -> ParsedEntry:
    """Margin operations: loan, forced repayment, liquidation."""
    amount = Decimal(row.change)
    op = row.operation

    if op == "Isolated Margin Loan":
        # Borrow: receive asset + incur debt
        splits = [
            ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount),
            ParsedSplit(
                account_subtype="protocol_debt", symbol=row.coin, quantity=-amount,
                account_params={"protocol": "binance_margin"},
            ),
        ]
        return ParsedEntry(splits=splits, entry_type="BORROW", source_rows=[row])

    elif op == "Isolated Margin Liquidation - Forced Repayment":
        # Forced repayment: negative = paid back debt
        splits = [
            ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount),
            ParsedSplit(
                account_subtype="protocol_debt", symbol=row.coin, quantity=-amount,
                account_params={"protocol": "binance_margin"},
            ),
        ]
        return ParsedEntry(splits=splits, entry_type="REPAY", source_rows=[row])

    elif op == "Cross Margin Liquidation - Small Assets Takeover":
        # Takeover: can be negative (asset taken) or positive (USDT received)
        # Treat as liquidation
        splits = [
            ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount),
            ParsedSplit(
                account_subtype="protocol_debt", symbol=row.coin, quantity=-amount,
                account_params={"protocol": "binance_margin"},
            ),
        ]
        return ParsedEntry(splits=splits, entry_type="LIQUIDATION", source_rows=[row])

    return ParsedEntry(
        splits=[ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount)],
        entry_type="UNKNOWN", source_rows=[row],
    )
```

### Task 5: Implement Flexible Loan handlers (BCSV-13)
**File**: `src/cryptotax/parser/cex/binance_csv.py`

```python
def _handle_loan(self, row: CsvImportRow) -> ParsedEntry:
    """Flexible Loan operations: collateral, lending, repayment."""
    amount = Decimal(row.change)
    op = row.operation

    if op == "Flexible Loan - Collateral Transfer":
        # Collateral locked: negative = moved from spot to collateral
        splits = [
            ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount),
            ParsedSplit(
                account_subtype="protocol_asset", symbol=row.coin, quantity=-amount,
                account_params={"protocol": "binance_loan"},
            ),
        ]
        return ParsedEntry(splits=splits, entry_type="DEPOSIT", source_rows=[row])

    elif op == "Flexible Loan - Lending":
        # Receive borrowed funds
        splits = [
            ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount),
            ParsedSplit(
                account_subtype="protocol_debt", symbol=row.coin, quantity=-amount,
                account_params={"protocol": "binance_loan"},
            ),
        ]
        return ParsedEntry(splits=splits, entry_type="BORROW", source_rows=[row])

    elif op == "Flexible Loan - Repayment":
        # Repay loan: negative = paid back
        splits = [
            ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount),
            ParsedSplit(
                account_subtype="protocol_debt", symbol=row.coin, quantity=-amount,
                account_params={"protocol": "binance_loan"},
            ),
        ]
        return ParsedEntry(splits=splits, entry_type="REPAY", source_rows=[row])

    return ParsedEntry(
        splits=[ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount)],
        entry_type="UNKNOWN", source_rows=[row],
    )
```

### Task 6: Implement Special Token + Cashback handlers (BCSV-14, BCSV-15)
**File**: `src/cryptotax/parser/cex/binance_csv.py`

```python
def _handle_special_tokens(self, rows: list[CsvImportRow]) -> list[ParsedEntry]:
    """RWUSD, BFUSD, WBETH operations."""
    entries = []
    for row in rows:
        amount = Decimal(row.change)
        op = row.operation

        if op in ("RWUSD - Subscription", "BFUSD Subscription"):
            # Swap: negative = spent asset, positive = received special token
            entries.append(ParsedEntry(
                splits=[ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount)],
                entry_type="SWAP",
                source_rows=[row],
            ))
        elif op in ("RWUSD - Distribution", "BFUSD Daily Reward"):
            # Income/reward
            entries.append(ParsedEntry(
                splits=[
                    ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount),
                    ParsedSplit(
                        account_subtype="wallet_income", symbol=row.coin, quantity=-amount,
                        account_params={"tag": "Token Reward"},
                    ),
                ],
                entry_type="YIELD",
                source_rows=[row],
            ))
        elif op == "RWUSD - Redemption":
            # Can produce 1 or 2 rows at same timestamp
            # Single-coin: direct swap back
            entries.append(ParsedEntry(
                splits=[ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount)],
                entry_type="SWAP",
                source_rows=[row],
            ))
        elif op == "WBETH2.0 - Staking":
            # ETH→WBETH swap: will be 2 rows at same timestamp (ETH negative, WBETH positive)
            entries.append(ParsedEntry(
                splits=[ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount)],
                entry_type="SWAP",
                source_rows=[row],
            ))

    return entries

def _handle_cashback(self, row: CsvImportRow) -> ParsedEntry:
    """Cashback Voucher: free income."""
    amount = Decimal(row.change)
    splits = [
        ParsedSplit(account_subtype="cex_asset", symbol=row.coin, quantity=amount),
        ParsedSplit(
            account_subtype="wallet_income", symbol=row.coin, quantity=-amount,
            account_params={"tag": "Cashback"},
        ),
    ]
    return ParsedEntry(splits=splits, entry_type="YIELD", source_rows=[row])
```

Note on special tokens: RWUSD/BFUSD subscription and WBETH staking produce 2 rows at same timestamp (one positive, one negative) that form a swap. The `_handle_special_tokens` method creates per-row entries; since they're at the same timestamp and both are SWAP type with cex_asset splits, the journal accurately records both sides. For RWUSD Redemption (line 273, 282 of CSV) there can be 1 row (RWUSD negative → converts to USDC in a separate row).

### Task 7: Handle "Transfer Funds to Spot/Funding" as internal transfers
**File**: `src/cryptotax/parser/cex/binance_csv.py`

These operations (lines 109, 112 of real CSV) are internal transfers with different naming:
- "Transfer Funds to Spot" + "Transfer Funds to Funding Wallet" at same timestamp

Add them to the transfer detection in `_parse_group()`:
```python
fund_transfer_rows = [r for r in rows if r.operation in TRANSFER_FUND_OPS]
# ...
if fund_transfer_rows:
    entries.append(self._handle_internal_transfer(fund_transfer_rows))
```

The existing `_handle_internal_transfer` works for these since they're mirrored pairs.

### Task 8: Write tests for all new operation handlers
**New file**: `tests/unit/test_binance_csv_extended.py`

Tests:
1. test_earn_subscription_produces_deposit — Flexible Sub -2 USDT → DEPOSIT
2. test_earn_redemption_produces_withdrawal — Flexible Redemption +2 USDT → WITHDRAWAL
3. test_earn_interest_produces_income — Flexible Interest +0.00027 USDT → YIELD
4. test_earn_locked_rewards_produces_income — Locked Rewards +0.005 FLOW → YIELD
5. test_futures_fee_produces_expense — Fee -0.01 USDT → expense entry
6. test_funding_fee_negative_produces_expense — Funding Fee -0.001 USDT → expense
7. test_funding_fee_positive_produces_income — Funding Fee +0.0007 USDT → income
8. test_realized_pnl_positive_produces_income — PnL +0.83 USDT → income
9. test_realized_pnl_negative_produces_expense — PnL -1.25 USDT → expense
10. test_margin_loan_produces_borrow — Margin Loan +3 USDT → BORROW
11. test_forced_repayment_produces_repay — Forced Repay -3 USDT → REPAY
12. test_liquidation_takeover — Small Assets Takeover: 2 rows (WLD negative, USDT positive) → LIQUIDATION
13. test_flexible_loan_collateral — Collateral Transfer -749 ANKR → DEPOSIT to protocol
14. test_flexible_loan_lending — Lending +2 USDT → BORROW
15. test_flexible_loan_repayment — Repayment -1.98 USDT → REPAY
16. test_rwusd_subscription — 2 rows (RWUSD +1, USDT -1) → SWAP entries
17. test_rwusd_distribution — +0.0001 RWUSD → YIELD income
18. test_bfusd_daily_reward — +0.0002 BFUSD → YIELD income
19. test_wbeth_staking — 2 rows (ETH -0.00065, WBETH +0.0006) → SWAP
20. test_cashback_produces_income — +0.004 USDT → YIELD income
21. test_transfer_funds_pair — Transfer Funds to Spot +0.245 USDT, Transfer Funds to Funding -0.245 USDT → TRANSFER
22. test_full_csv_coverage — Parse ALL rows from real CSV data, assert zero skipped rows

### Task 9: Verify full coverage and run all checks
Run:
- `python -m pytest tests/ -x -q` — all tests pass (target: 422 + ~22 new = ~444)
- `ruff check src/` — 0 lint errors
- `cd web && npx tsc --noEmit` — 0 TS errors
- Verify: no operation from the real CSV produces "skipped" status

## Verification
1. `python -m pytest tests/ -x -q` — all existing + new tests pass
2. `ruff check src/` — 0 lint errors
3. Every operation type from the real CSV has a handler (no more "skipped" rows)
4. Earn subscription/redemption: balanced with protocol_asset counterpart
5. Earn interest/rewards: balanced with wallet_income counterpart
6. Futures fee/funding fee: balanced with wallet_expense (negative) or wallet_income (positive)
7. Realized PnL: income for gains, expense for losses
8. Margin loan: BORROW with protocol_debt counterpart
9. Margin forced repayment: REPAY with protocol_debt counterpart
10. Liquidation: LIQUIDATION entry type
11. Flexible Loan: collateral→protocol_asset, lending→BORROW, repayment→REPAY
12. Special tokens: subscription/staking as SWAP, distribution/reward as YIELD
13. Cashback: YIELD income entry

## Risks
- **Special token multi-row grouping**: RWUSD Subscription produces 2 rows (RWUSD +1, USDT -1) at same timestamp. The handler creates 2 separate single-row entries instead of 1 combined entry. This is acceptable since both sides are recorded in the journal.
- **Futures fee at same timestamp as PnL**: Lines 107-108 of CSV show "Realized Profit and Loss" and "Fee" at same timestamp with same TradeID. The dispatch splits them into separate entries — correct since they represent different accounting events.
