---
phase: 12-management-dashboard-comprehensive-analytics
plan: 02
type: execute
wave: 2
depends_on:
  - 12-01
files_modified:
  - src/cryptotax/api/analytics.py
  - src/cryptotax/api/main.py
  - src/cryptotax/api/schemas/analytics.py
  - src/cryptotax/db/repos/transaction_repo.py
  - src/cryptotax/db/repos/journal_repo.py
  - src/cryptotax/api/transactions.py
  - src/cryptotax/api/journal.py
  - src/cryptotax/api/tax.py
  - src/cryptotax/api/accounts.py
autonomous: true
requirements:
  - ANAL-04
  - ANAL-05
  - ANAL-06

must_haves:
  truths:
    - "GET /api/analytics/overview returns combined KPI + cash flow + composition data"
    - "GET /api/analytics/cash-flow, income-expense, balance-over-time, top-symbols, top-protocols, composition, activity, entry-types, flow-by-wallet, flow-by-chain all return analytics data"
    - "GET /api/analytics/tax/* endpoints return tax analytics data from TaxAnalyticsRepo"
    - "Existing endpoints /api/transactions, /api/journal, /api/tax/realized-gains, /api/tax/open-lots, /api/accounts accept new filter parameters"
  artifacts:
    - path: "src/cryptotax/api/analytics.py"
      provides: "Analytics API router with 19 endpoints"
      contains: "router = APIRouter"
    - path: "src/cryptotax/api/schemas/analytics.py"
      provides: "Pydantic response models for analytics"
      contains: "class KPISummaryResponse"
  key_links:
    - from: "src/cryptotax/api/analytics.py"
      to: "src/cryptotax/db/repos/analytics_repo.py"
      via: "instantiate AnalyticsRepo(db) and call methods"
      pattern: "AnalyticsRepo\\(db\\)"
    - from: "src/cryptotax/api/analytics.py"
      to: "src/cryptotax/db/repos/tax_analytics_repo.py"
      via: "instantiate TaxAnalyticsRepo(db) and call methods"
      pattern: "TaxAnalyticsRepo\\(db\\)"
    - from: "src/cryptotax/api/main.py"
      to: "src/cryptotax/api/analytics.py"
      via: "app.include_router(analytics_router)"
      pattern: "include_router.*analytics"
---

<objective>
Create the analytics API router with all 19 endpoints, Pydantic response schemas, register it in main.py, and extend existing API routers with comprehensive filter parameters.

Purpose: Expose all analytics data from Plan 01's repos to the frontend. Also add missing filter params (date range, symbol, wallet, protocol) to existing endpoints so existing pages can be improved.

Output: analytics.py router (19 endpoints), analytics schemas, updated transaction/journal/tax/accounts endpoints with filters
</objective>

<execution_context>
@C:/Users/PC/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/PC/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-management-dashboard-comprehensive-analytics/12-01-SUMMARY.md
@src/cryptotax/api/main.py
@src/cryptotax/api/deps.py
@src/cryptotax/api/journal.py
@src/cryptotax/api/transactions.py
@src/cryptotax/api/tax.py
@src/cryptotax/api/accounts.py
@src/cryptotax/api/schemas/journal.py
@src/cryptotax/api/schemas/tax.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics Pydantic schemas and API router with 19 endpoints</name>
  <files>
    src/cryptotax/api/schemas/analytics.py
    src/cryptotax/api/analytics.py
    src/cryptotax/api/main.py
  </files>
  <action>
**Step 1: Create Pydantic response schemas** in `src/cryptotax/api/schemas/analytics.py`:

Define response models for each analytics endpoint. Use `BaseModel` with `model_config = ConfigDict(from_attributes=True)` where needed. Key schemas:

- `CashFlowPeriod(period: str, inflow_usd: float, inflow_vnd: float, outflow_usd: float, outflow_vnd: float, net_usd: float, net_vnd: float)`
- `KPISummaryResponse(total_inflow_usd: float, total_inflow_vnd: float, total_outflow_usd: float, total_outflow_vnd: float, net_usd: float, net_vnd: float, total_entries: int, total_txs: int, unique_tokens: int, unique_protocols: int)`
- `SymbolVolume(symbol: str, volume_usd: float, inflow_usd: float, outflow_usd: float, tx_count: int)`
- `ProtocolVolume(protocol: str, volume_usd: float, tx_count: int, entry_types: list[str])`
- `CompositionItem(account_type: str, subtype: str, symbol: str | None, protocol: str | None, balance_qty: float, balance_usd: float, balance_vnd: float)`
- `ActivityDay(date: str, count: int, volume_usd: float)`
- `EntryTypeBreakdown(entry_type: str, count: int, volume_usd: float)`
- `IncomeExpensePeriod(period: str, income_usd: float, income_vnd: float, expense_usd: float, expense_vnd: float)`
- `BalancePeriod(period: str, symbol: str, cumulative_qty: float, cumulative_usd: float)`
- `WalletFlow(wallet_id: str, label: str | None, chain: str | None, inflow_usd: float, outflow_usd: float, net_usd: float, tx_count: int)`
- `ChainFlow(chain: str, inflow_usd: float, outflow_usd: float, net_usd: float, tx_count: int)`
- Tax analytics schemas: `RealizedGainsPeriod`, `GainsBySymbol`, `HoldingBucket`, `WinnersLosers`, `TaxBreakdownPeriod`, `TaxByCategory`, `UnrealizedPosition`, `CostBasisItem`
- `OverviewResponse` combining KPI + recent cash flow + composition snapshot

**Step 2: Create analytics router** in `src/cryptotax/api/analytics.py`:

Follow same pattern as existing routers (APIRouter, DbDep, resolve_entity dependency). Prefix: `/api/analytics`.

Common query params for most endpoints: `entity_id` (via resolve_entity), `date_from: Optional[datetime]`, `date_to: Optional[datetime]`, `wallet_id: Optional[UUID]`, `chain: Optional[str]`, `symbol: Optional[str]`, `entry_type: Optional[str]`, `account_type: Optional[str]`, `protocol: Optional[str]`, `account_subtype: Optional[str]`.

Create a helper function `_common_filters(entity, date_from, date_to, ...)` that builds the kwargs dict for repo methods.

Endpoints (11 general + 8 tax):

General:
1. `GET /api/analytics/overview` — Calls `get_kpi_summary` + `get_cash_flow_series(granularity="month")` (last 12 months) + `get_composition_snapshot`. Returns `OverviewResponse`.
2. `GET /api/analytics/cash-flow?granularity=month` — Returns `list[CashFlowPeriod]`
3. `GET /api/analytics/income-expense?granularity=month` — Returns `list[IncomeExpensePeriod]`
4. `GET /api/analytics/balance-over-time?granularity=month&symbols=ETH,USDC` — Returns `list[BalancePeriod]`
5. `GET /api/analytics/top-symbols?limit=20` — Returns `list[SymbolVolume]`
6. `GET /api/analytics/top-protocols?limit=20` — Returns `list[ProtocolVolume]`
7. `GET /api/analytics/composition` — Returns `list[CompositionItem]`
8. `GET /api/analytics/activity?days=365` — Returns `list[ActivityDay]`
9. `GET /api/analytics/entry-types` — Returns `list[EntryTypeBreakdown]`
10. `GET /api/analytics/flow-by-wallet` — Returns `list[WalletFlow]`
11. `GET /api/analytics/flow-by-chain` — Returns `list[ChainFlow]`

Tax:
12. `GET /api/analytics/tax/gains-over-time?granularity=month` — Returns `list[RealizedGainsPeriod]`
13. `GET /api/analytics/tax/gains-by-symbol` — Returns `list[GainsBySymbol]`
14. `GET /api/analytics/tax/holding-distribution` — Returns `list[HoldingBucket]`
15. `GET /api/analytics/tax/winners-losers?limit=10` — Returns `WinnersLosers`
16. `GET /api/analytics/tax/breakdown?granularity=month` — Returns `list[TaxBreakdownPeriod]`
17. `GET /api/analytics/tax/by-category` — Returns `list[TaxByCategory]`
18. `GET /api/analytics/tax/unrealized` — Returns `list[UnrealizedPosition]`
19. `GET /api/analytics/tax/cost-basis` — Returns `list[CostBasisItem]`

Each endpoint instantiates the appropriate repo, calls the method with filters, converts Decimal results to float for JSON serialization in the response model.

**Step 3: Register in main.py** — Add `from cryptotax.api.analytics import router as analytics_router` and `app.include_router(analytics_router)`.
  </action>
  <verify>
Run: `python -c "from cryptotax.api.analytics import router; print(len(router.routes))"` — should show 19 routes.
Run: `python -c "from cryptotax.api.schemas.analytics import OverviewResponse; print('OK')"` — schema imports.
Run: `ruff check src/cryptotax/api/analytics.py src/cryptotax/api/schemas/analytics.py` — no lint errors.
  </verify>
  <done>Analytics API router with 19 endpoints is registered in main.py, all using proper Pydantic response models and connecting to AnalyticsRepo/TaxAnalyticsRepo.</done>
</task>

<task type="auto">
  <name>Task 2: Extend existing API routers with comprehensive filter parameters</name>
  <files>
    src/cryptotax/db/repos/transaction_repo.py
    src/cryptotax/db/repos/journal_repo.py
    src/cryptotax/api/transactions.py
    src/cryptotax/api/journal.py
    src/cryptotax/api/tax.py
    src/cryptotax/api/accounts.py
  </files>
  <action>
**TransactionRepo + API** — Add `date_from: Optional[datetime]` and `date_to: Optional[datetime]` params to `list_for_entity`. In the repo, apply `Transaction.timestamp >= func.extract('epoch', date_from)` (since Transaction.timestamp is BigInteger unix epoch). In the API router `list_transactions`, add `date_from` and `date_to` query params.

**JournalRepo + API** — Add to `list_for_entity`: `date_from`, `date_to`, `symbol`, `account_type`, `wallet_id`, `protocol`, `account_subtype`. For symbol/account_type/wallet_id/protocol/account_subtype filters, the repo needs to join JournalSplit -> Account -> Wallet. Apply filters on respective columns. In journal API, add these as query params. Use `distinct()` on JournalEntry to avoid duplicates from the join.

**Tax API (realized-gains endpoint)** — Add query params: `symbol`, `date_from`, `date_to` (filter on sell_timestamp), `gain_only` (bool, filter gain_usd > 0), `loss_only` (bool, filter gain_usd < 0), `min_holding_days`, `max_holding_days`. Apply as WHERE clauses on ClosedLotRecord.

**Tax API (open-lots endpoint)** — Add query params: `symbol`, `min_quantity`.

**Accounts API** — Add query params to the list endpoint: `subtype`, `symbol`, `protocol`, `wallet_id`. Apply as WHERE clauses on Account model. For the account history (splits) endpoint, add `date_from`, `date_to` — join JournalSplit -> JournalEntry to filter by JournalEntry.timestamp.

All new parameters should be Optional with default None, so existing calls remain backward-compatible.
  </action>
  <verify>
Run: `ruff check src/cryptotax/api/transactions.py src/cryptotax/api/journal.py src/cryptotax/api/tax.py src/cryptotax/api/accounts.py` — no lint errors.
Run: `python -c "from cryptotax.api.main import app; print('OK')"` — app still loads.
  </verify>
  <done>Existing endpoints accept new filter parameters (date range, symbol, wallet, protocol, account type) while remaining backward-compatible with no required params changed.</done>
</task>

</tasks>

<verification>
- `python -c "from cryptotax.api.main import app; routes = [r.path for r in app.routes]; print(len([r for r in routes if 'analytics' in r]))"` — shows 19+ analytics routes
- All existing endpoints still work without new params
- `ruff check src/cryptotax/api/` — no lint errors across all API files
</verification>

<success_criteria>
- 19 analytics endpoints are accessible and return proper response models
- Existing transaction, journal, tax, and accounts endpoints accept new filter parameters
- All new parameters are optional with backward-compatible defaults
- Analytics router is registered in main.py
</success_criteria>

<output>
After completion, create `.planning/phases/12-management-dashboard-comprehensive-analytics/12-02-SUMMARY.md`
</output>
