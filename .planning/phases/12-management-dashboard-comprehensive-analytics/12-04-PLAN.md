---
phase: 12-management-dashboard-comprehensive-analytics
plan: 04
type: execute
wave: 3
depends_on:
  - 12-02
  - 12-03
files_modified:
  - web/src/components/charts/CashFlowChart.tsx
  - web/src/components/charts/IncomeExpenseChart.tsx
  - web/src/components/charts/BalanceOverTimeChart.tsx
  - web/src/components/charts/CompositionDonut.tsx
  - web/src/components/charts/EntryTypeBar.tsx
  - web/src/components/charts/GainsLossChart.tsx
  - web/src/components/charts/HoldingDistribution.tsx
  - web/src/components/charts/WinnersLosers.tsx
  - web/src/components/charts/ActivityHeatmap.tsx
  - web/src/components/charts/KPICard.tsx
  - web/src/components/charts/index.ts
  - web/src/api/analytics.ts
  - web/src/hooks/useAnalytics.ts
autonomous: true
requirements:
  - ANAL-09
  - ANAL-10
  - ANAL-11

must_haves:
  truths:
    - "Recharts-based chart components render data from analytics API responses"
    - "KPICard displays a metric with label, value, change indicator, and icon"
    - "useAnalytics hooks fetch from /api/analytics/* endpoints with entity context and filters"
    - "Analytics API client has TypeScript interfaces matching backend Pydantic schemas"
  artifacts:
    - path: "web/src/api/analytics.ts"
      provides: "TypeScript API client for all analytics endpoints"
      contains: "fetchOverview"
    - path: "web/src/hooks/useAnalytics.ts"
      provides: "TanStack Query hooks for analytics data"
      contains: "useOverview"
    - path: "web/src/components/charts/index.ts"
      provides: "Barrel export for all chart components"
      contains: "export"
  key_links:
    - from: "web/src/hooks/useAnalytics.ts"
      to: "web/src/api/analytics.ts"
      via: "TanStack useQuery calling fetch functions"
      pattern: "useQuery.*queryFn.*fetch"
    - from: "web/src/components/charts/CashFlowChart.tsx"
      to: "recharts"
      via: "import BarChart from recharts"
      pattern: "import.*from 'recharts'"
---

<objective>
Create Recharts-based chart components, the analytics TypeScript API client, and TanStack Query hooks. Also extend existing API clients (transactions, journal, tax) with new filter params.

Purpose: These charts and hooks are the data visualization layer that connects backend analytics APIs to frontend pages. Charts render the data, hooks fetch it, API client types ensure type safety.

Output: 10 chart components + KPICard, analytics.ts API client, useAnalytics.ts hooks, extended existing API clients
</objective>

<execution_context>
@C:/Users/PC/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/PC/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/12-management-dashboard-comprehensive-analytics/12-02-SUMMARY.md
@.planning/phases/12-management-dashboard-comprehensive-analytics/12-03-SUMMARY.md
@web/src/api/client.ts
@web/src/api/journal.ts
@web/src/api/tax.ts
@web/src/hooks/useJournal.ts
@web/src/hooks/useTax.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics API client and TanStack Query hooks</name>
  <files>
    web/src/api/analytics.ts
    web/src/hooks/useAnalytics.ts
    web/src/api/transactions.ts
    web/src/api/journal.ts
    web/src/api/tax.ts
  </files>
  <action>
**analytics.ts** — Define TypeScript interfaces matching backend Pydantic schemas from Plan 02:

```typescript
export interface AnalyticsFilters {
  date_from?: string
  date_to?: string
  wallet_id?: string
  chain?: string
  symbol?: string
  entry_type?: string
  account_type?: string
  protocol?: string
  account_subtype?: string
  granularity?: string
}
```

Plus all response interfaces: `CashFlowPeriod`, `KPISummary`, `SymbolVolume`, `ProtocolVolume`, `CompositionItem`, `ActivityDay`, `EntryTypeBreakdown`, `IncomeExpensePeriod`, `BalancePeriod`, `WalletFlow`, `ChainFlow`, `OverviewResponse`, plus tax analytics: `RealizedGainsPeriod`, `GainsBySymbol`, `HoldingBucket`, `WinnersLosers`, `TaxBreakdownPeriod`, `TaxByCategory`, `UnrealizedPosition`, `CostBasisItem`.

Create fetch functions using `apiFetch` + `withEntityId` pattern:
- `fetchOverview(filters, entityId)` -> GET /analytics/overview
- `fetchCashFlow(filters, entityId)` -> GET /analytics/cash-flow
- `fetchIncomeExpense(filters, entityId)` -> GET /analytics/income-expense
- `fetchBalanceOverTime(filters, entityId)` -> GET /analytics/balance-over-time
- `fetchTopSymbols(filters, entityId)` -> GET /analytics/top-symbols
- `fetchTopProtocols(filters, entityId)` -> GET /analytics/top-protocols
- `fetchComposition(filters, entityId)` -> GET /analytics/composition
- `fetchActivity(filters, entityId)` -> GET /analytics/activity
- `fetchEntryTypes(filters, entityId)` -> GET /analytics/entry-types
- `fetchFlowByWallet(filters, entityId)` -> GET /analytics/flow-by-wallet
- `fetchFlowByChain(filters, entityId)` -> GET /analytics/flow-by-chain
- Tax: `fetchGainsOverTime`, `fetchGainsBySymbol`, `fetchHoldingDistribution`, `fetchWinnersLosers`, `fetchTaxBreakdown`, `fetchTaxByCategory`, `fetchUnrealized`, `fetchCostBasis`

Helper to build query string from AnalyticsFilters (skip null/undefined values).

**useAnalytics.ts** — TanStack Query hooks using `useEntity()` context:
- `useOverview(filters)`, `useCashFlow(filters)`, `useIncomeExpense(filters)`, etc.
- Each hook: `useQuery({ queryKey: ['analytics', endpoint, entityId, filters], queryFn: () => fetchFn(filters, entityId) })`
- Tax hooks: `useGainsOverTime(filters)`, `useGainsBySymbol(filters)`, etc.

**Extend existing API clients:**
- `transactions.ts`: Update `TransactionFilters` to add `date_from?: string`, `date_to?: string`. Update `listTransactions` to pass these params.
- `journal.ts`: Update `JournalFilters` to add `date_from`, `date_to`, `symbol`, `account_type`, `wallet_id`, `protocol`, `account_subtype`. Update `listJournalEntries`.
- `tax.ts`: Add filter params to `getRealizedGains` (symbol, date_from, date_to, gain_only, loss_only) and `getOpenLots` (symbol, min_quantity).
  </action>
  <verify>
Run: `cd web && npx tsc --noEmit` — no TypeScript errors.
Verify analytics.ts exports all fetch functions and interfaces.
  </verify>
  <done>Analytics API client with 19 fetch functions, TanStack hooks for all endpoints, and extended existing API clients with new filter parameters — all type-safe.</done>
</task>

<task type="auto">
  <name>Task 2: Create 10 Recharts chart components + KPICard</name>
  <files>
    web/src/components/charts/CashFlowChart.tsx
    web/src/components/charts/IncomeExpenseChart.tsx
    web/src/components/charts/BalanceOverTimeChart.tsx
    web/src/components/charts/CompositionDonut.tsx
    web/src/components/charts/EntryTypeBar.tsx
    web/src/components/charts/GainsLossChart.tsx
    web/src/components/charts/HoldingDistribution.tsx
    web/src/components/charts/WinnersLosers.tsx
    web/src/components/charts/ActivityHeatmap.tsx
    web/src/components/charts/KPICard.tsx
    web/src/components/charts/index.ts
  </files>
  <action>
All chart components accept data props matching the TypeScript interfaces from analytics.ts. Use Recharts (already in package.json). Wrap in a white card with title: `<div className="bg-white rounded-xl border border-gray-200 p-5">`. Show "No data" message when data array is empty.

1. **CashFlowChart** — `BarChart` with stacked bars. Green bars for inflow_usd, red bars for outflow_usd. X-axis: period (formatted date). Tooltip showing USD values. Props: `data: CashFlowPeriod[]`. Use `ResponsiveContainer` width="100%" height={300}.

2. **IncomeExpenseChart** — `AreaChart`. Green area for income_usd, orange area for expense_usd. Stacked. Props: `data: IncomeExpensePeriod[]`.

3. **BalanceOverTimeChart** — `LineChart` with multiple lines (one per symbol). Different colors. Legend showing symbols. Props: `data: BalancePeriod[]`. Group by symbol and render a Line per unique symbol.

4. **CompositionDonut** — `PieChart` with `Pie` component. Show account_type breakdown (ASSET, LIABILITY, INCOME, EXPENSE) by balance_usd sum. Color coding: ASSET=blue, LIABILITY=red, INCOME=green, EXPENSE=orange. Props: `data: CompositionItem[]`. Aggregate by account_type before rendering.

5. **EntryTypeBar** — Horizontal `BarChart` (layout="vertical"). Each bar = entry type. Shows count or volume_usd. Props: `data: EntryTypeBreakdown[]`.

6. **GainsLossChart** — `BarChart`. Green bars for gains, red for losses, line overlay for net. Props: `data: RealizedGainsPeriod[]`.

7. **HoldingDistribution** — `BarChart`. X-axis: holding period bucket labels. Y-axis: count. Color by positive/negative gain. Props: `data: HoldingBucket[]`.

8. **WinnersLosers** — NOT a Recharts component. Two columns: Winners (green) and Losers (red). List top symbols with gain/loss amounts. Props: `data: WinnersLosers` (has `winners` and `losers` arrays).

9. **ActivityHeatmap** — Pure Tailwind CSS grid (NOT Recharts). 52 columns (weeks) x 7 rows (days). Each cell colored by intensity (gray-100 to green-500 based on volume percentile). Props: `data: ActivityDay[]`. Parse dates and position into grid. If data is sparse, show empty cells as gray-50.

10. **KPICard** — A stat card component. Props: `label: string`, `value: string | number`, `icon?: React.ReactNode`, `change?: { value: number, label: string }`, `color?: string`. White card bg, large bold value, small label, optional colored change indicator (+12% green, -5% red).

11. **index.ts** — Barrel export all components.

Charts should handle loading/empty states gracefully. Format numbers with toLocaleString(). USD values format as "$X,XXX.XX".
  </action>
  <verify>
Run: `cd web && npx tsc --noEmit` — no TypeScript errors.
Verify all 11 files exist in `web/src/components/charts/`.
  </verify>
  <done>10 Recharts chart components + KPICard exist with proper data props, responsive containers, consistent card styling, and empty state handling.</done>
</task>

</tasks>

<verification>
- `cd web && npx tsc --noEmit` — zero TypeScript errors
- All chart components import from 'recharts' (except ActivityHeatmap and WinnersLosers)
- Analytics hooks use entityId in query keys
- Barrel exports provide clean imports
</verification>

<success_criteria>
- All chart components render data from properly typed analytics API responses
- TanStack hooks fetch data with entity context and filter support
- Extended API clients pass new filter params to backend
- Charts use Recharts ResponsiveContainer for responsive sizing
- KPICard is reusable for any metric display
</success_criteria>

<output>
After completion, create `.planning/phases/12-management-dashboard-comprehensive-analytics/12-04-SUMMARY.md`
</output>
